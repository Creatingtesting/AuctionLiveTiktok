<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabTraderOnLive Gift Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #000 0%, #111 100%);
            color: #fff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .minimum {
            background: #ff0050;
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px #ff0050; }
            to { box-shadow: 0 0 20px #ff0050; }
        }
        .total {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #00ff88;
            margin-bottom: 20px;
        }
        .connect-btn {
            background: #ff0050;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 auto 20px;
            display: block;
            transition: background 0.3s;
        }
        .connect-btn:hover { background: #cc0040; }
        .connect-btn:disabled { background: #333; cursor: not-allowed; }
        #log {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 10px;
            background: #1a1a1a;
        }
        .gift-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 5px;
            background: #222;
            border-radius: 5px;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .status.connected { background: #00ff88; color: #000; }
        .status.disconnected { background: #ff4444; color: #fff; }
        .status.connecting { background: #ffaa00; color: #000; }
    </style>
</head>
<body>
    <div class="header">
        <h1>SabTraderOnLive Auction Gifts</h1>
        <div class="minimum">50 Minimum</div>
        <div class="total">Total Donated: <span id="total-coins">0</span> Coins</div>
        <button id="connect-btn" class="connect-btn">Connect to Live</button>
        <div id="status" class="status disconnected">Disconnected - Start live to connect</div>
    </div>
    <div id="log"></div>

    <script>
        const USERNAME = 'sabtraderonlive'; // Your TikTok username (no @)
        const MINIMUM = 50;
        let totalCoins = 0;
        let isConnected = false;
        const log = document.getElementById('log');
        const totalEl = document.getElementById('total-coins');
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('connect-btn');
        let ws = null;

        // Updated room info fetch (2025 API)
        async function fetchRoomId() {
            try {
                const res = await fetch(`https://www.tiktok.com/api/v1/room/info/?uniqueId=${USERNAME}`);
                if (!res.ok) throw new Error('Stream not live');
                const data = await res.json();
                return data.data.roomId;
            } catch (e) {
                throw new Error('Failed to fetch room: ' + e.message);
            }
        }

        // Check if live (optional, for auto-connect)
        async function isLive() {
            try {
                const res = await fetch(`https://www.tiktok.com/api/v1/room/info/?uniqueId=${USERNAME}`);
                const data = await res.json();
                return data.data.status === 2; // 2 = live
            } catch {
                return false;
            }
        }

        async function connectToLive() {
            if (isConnected) return;
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'status connecting';

            try {
                // Fetch room ID
                const roomId = await fetchRoomId();
                if (!roomId) throw new Error('No room ID found');

                // EulerStream proxy WS (signed, 2025 compatible - no key needed for free tier)
                const wsUrl = `wss://ws.eulerstream.com/?roomId=${roomId}&uniqueId=${USERNAME}`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    // Send subscribe (Euler format)
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        roomId: roomId,
                        events: ['gift', 'connect']
                    }));
                    isConnected = true;
                    statusEl.textContent = 'Connected - Tracking Gifts!';
                    statusEl.className = 'status connected';
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'gift' || data.event === 'gift') {
                            const donor = data.user?.nickname || data.uniqueId || 'Anonymous';
                            const giftName = data.gift?.name || 'Gift';
                            const coins = data.gift?.diamondCount || data.cost || 1; // Coin cost
                            const repeats = data.repeatCount || data.comboCount || 1;
                            const totalGiftCoins = coins * repeats;

                            totalCoins += totalGiftCoins;
                            totalEl.textContent = totalCoins;

                            // Log entry
                            const entry = document.createElement('div');
                            entry.className = 'gift-entry';
                            entry.innerHTML = `<span>${donor} sent ${giftName} x${repeats}</span><span>${totalGiftCoins} Coins</span>`;
                            log.insertBefore(entry, log.firstChild);
                            log.scrollTop = 0;

                            // Minimum check
                            if (totalCoins >= MINIMUM && !statusEl.innerHTML.includes('Eligible')) {
                                statusEl.innerHTML += ` <strong style="color: #00ff88;">(Eligible!)</strong>`;
                            }
                        } else if (data.type === 'connect') {
                            console.log('Euler connected to room:', roomId);
                        }
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                };

                ws.onclose = () => {
                    disconnect();
                    // Auto-reconnect in 5s if was connected
                    if (isConnected) setTimeout(connectToLive, 5000);
                };

                ws.onerror = (err) => {
                    throw new Error('WS Error: ' + err);
                };

            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message + ' (Is the stream live?)';
                statusEl.className = 'status disconnected';
                btn.disabled = false;
                btn.textContent = 'Retry Connect';
            }
        }

        function disconnect() {
            if (ws) ws.close();
            isConnected = false;
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'status disconnected';
            btn.textContent = 'Connect to Live';
            btn.disabled = false;
        }

        btn.addEventListener('click', () => isConnected ? disconnect() : connectToLive());

        // Auto-check if live on load
        window.addEventListener('load', async () => {
            if (await isLive()) connectToLive();
        });
    </script>
</body>
</html>
